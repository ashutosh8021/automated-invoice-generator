<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
  <h1 class="h2">Invoice Details</h1>
  <div class="btn-toolbar mb-2 mb-md-0" *ngIf="invoice">
    <div class="btn-group me-2">
      <button type="button" class="btn btn-outline-primary" [routerLink]="['/invoices', invoice.id, 'edit']">
        <i class="fas fa-edit"></i> Edit
      </button>
      <button type="button" class="btn btn-outline-success" (click)="downloadPDF()">
        <i class="fas fa-file-pdf"></i> Download PDF
      </button>
      <button type="button" class="btn btn-outline-warning" (click)="sendEmail()">
        <i class="fas fa-envelope"></i> Send Email
      </button>
    </div>
  </div>
</div>

<div *ngIf="invoice" class="invoice-container">
  <!-- Company Header -->
  <div class="card mb-4">
    <div class="card-body text-center">
      <h2 class="text-primary mb-3">{{ companyInfo.companyName }}</h2>
      <div class="text-muted">
        <p class="mb-1" *ngIf="companyInfo.companyAddress">{{ companyInfo.companyAddress }}</p>
        <div class="d-flex justify-content-center flex-wrap">
          <span *ngIf="companyInfo.companyPhone" class="me-3">
            <i class="fas fa-phone"></i> {{ companyInfo.companyPhone }}
          </span>
          <span *ngIf="companyInfo.companyEmail" class="me-3">
            <i class="fas fa-envelope"></i> {{ companyInfo.companyEmail }}
          </span>
          <span *ngIf="companyInfo.companyWebsite">
            <i class="fas fa-globe"></i> {{ companyInfo.companyWebsite }}
          </span>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Header -->
  <div class="card mb-4">
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h3 class="text-primary mb-3">{{ invoice.invoice_number || 'INV-' + invoice.id }}</h3>
          <div class="mb-2">
            <strong>Issue Date:</strong> {{ invoice.invoice_date | date:'mediumDate' }}
          </div>
          <div class="mb-2">
            <strong>Due Date:</strong> 
            <span [class]="getDueDateClass(invoice.due_date, invoice.payment_status)">
              {{ invoice.due_date | date:'mediumDate' }}
            </span>
          </div>
          <div class="mb-2">
            <strong>Status:</strong>
            <span class="badge ms-2" [ngClass]="getStatusBadgeClass(invoice.payment_status || 'PENDING')">
              {{ invoice.payment_status }}
            </span>
          </div>
        </div>
        <div class="col-md-6 text-end">
          <div class="invoice-total">
            <h2 class="text-primary mb-0">₹{{ invoice.total | number:'1.2-2' }}</h2>
            <small class="text-muted">Total Amount</small>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Customer Information -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Bill To</h5>
    </div>
    <div class="card-body">
      <div class="row">
        <div class="col-md-6">
          <h6 class="fw-bold">{{ invoice.customer_name }}</h6>
          <div class="mb-1" *ngIf="invoice.customer_email">
            <strong>Email:</strong> 
            <a [href]="'mailto:' + invoice.customer_email">{{ invoice.customer_email }}</a>
          </div>
          <div *ngIf="invoice.customer_phone" class="mb-1">
            <strong>Phone:</strong> 
            <a [href]="'tel:' + invoice.customer_phone">{{ invoice.customer_phone }}</a>
          </div>
        </div>
        <div class="col-md-6">
          <div *ngIf="invoice.customer_address">
            <strong>Address:</strong><br>
            {{ invoice.customer_address }}<br>
            <span *ngIf="invoice.customer_city">{{ invoice.customer_city }}, </span>
            <span *ngIf="invoice.customer_state">{{ invoice.customer_state }} </span>
            <span *ngIf="invoice.customer_postal_code">{{ invoice.customer_postal_code }}</span><br>
            <span *ngIf="invoice.customer_country">{{ invoice.customer_country }}</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Invoice Items -->
  <div class="card mb-4">
    <div class="card-header">
      <h5 class="card-title mb-0">Items</h5>
    </div>
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-sm">
          <thead>
            <tr>
              <th>Description</th>
              <th class="text-center">Quantity</th>
              <th class="text-end">Unit Price</th>
              <th class="text-end">Total</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let item of invoice.items">
              <td>{{ item.description }}</td>
              <td class="text-center">{{ item.quantity }}</td>
              <td class="text-end">₹{{ item.unitPrice | number:'1.2-2' }}</td>
              <td class="text-end">₹{{ (item.quantity * item.unitPrice) | number:'1.2-2' }}</td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Invoice Summary -->
  <div class="row">
    <div class="col-md-8">
      <!-- Notes and Terms -->
      <div class="card" *ngIf="invoice.notes || invoice.terms">
        <div class="card-header">
          <h5 class="card-title mb-0">Additional Information</h5>
        </div>
        <div class="card-body">
          <div *ngIf="invoice.notes" class="mb-3">
            <h6>Notes:</h6>
            <p class="text-muted">{{ invoice.notes }}</p>
          </div>
          <div *ngIf="invoice.terms">
            <h6>Terms & Conditions:</h6>
            <p class="text-muted">{{ invoice.terms }}</p>
          </div>
        </div>
      </div>
    </div>
    
    <div class="col-md-4">
      <div class="card">
        <div class="card-header">
          <h5 class="card-title mb-0">Summary</h5>
        </div>
        <div class="card-body">
          <div class="d-flex justify-content-between mb-2">
            <span>Subtotal:</span>
            <span>₹{{ invoice.subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="d-flex justify-content-between mb-2">
            <span>Tax ({{ invoice.tax_rate || 0 }}%):</span>
            <span>₹{{ invoice.tax_amount | number:'1.2-2' }}</span>
          </div>
          <hr>
          <div class="d-flex justify-content-between">
            <strong>Total:</strong>
            <strong class="text-primary">₹{{ invoice.total | number:'1.2-2' }}</strong>
          </div>
        </div>
      </div>

      <!-- Payment Status Actions -->
      <div class="card mt-3" *ngIf="invoice.payment_status !== 'PAID'">
        <div class="card-header">
          <h6 class="card-title mb-0">Quick Actions</h6>
        </div>
        <div class="card-body">
          <div class="d-grid gap-2">
            <button 
              type="button" 
              class="btn btn-success btn-sm"
              (click)="markAsPaid()"
              *ngIf="invoice.payment_status === 'PENDING'">
              Mark as Paid
            </button>
            <button 
              type="button" 
              class="btn btn-warning btn-sm"
              (click)="markAsOverdue()"
              *ngIf="invoice.payment_status === 'PENDING'">
              Mark as Overdue
            </button>
            <button 
              type="button" 
              class="btn btn-info btn-sm"
              (click)="sendReminder()">
              Send Reminder
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div *ngIf="!invoice && !loading" class="text-center py-5">
  <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
  <h4>Invoice Not Found</h4>
  <p class="text-muted">The requested invoice could not be found.</p>
  <button type="button" class="btn btn-primary" routerLink="/invoices">
    Back to Invoices
  </button>
</div>

<div *ngIf="loading" class="text-center py-5">
  <div class="spinner-border text-primary" role="status">
    <span class="visually-hidden">Loading...</span>
  </div>
  <p class="mt-3 text-muted">Loading invoice...</p>
</div>
